<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealTaxi - Taxi Booking System</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- Leaflet.js for Map Visualization -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // OpenRouteService API Configuration
        let orsApiKey = '';
        let mapsLoaded = false;
        
        async function loadMapsConfig() {
            try {
                const response = await fetch('/config/maps');
                const config = await response.json();
                console.log('üìã Maps config loaded:', config);
                
                // Get OpenRouteService API key from backend
                // Can be overridden by window.OPENROUTESERVICE_API_KEY
                orsApiKey = window.OPENROUTESERVICE_API_KEY || config.ors_api_key || '';
                
                if (orsApiKey && orsApiKey !== '' && orsApiKey !== 'null' && orsApiKey !== 'undefined') {
                    window.ORS_API_KEY = orsApiKey;
                    window.OPENROUTESERVICE_API_KEY = orsApiKey; // Also set alternative name
                    window.mapsLoaded = true; // Set as global window variable
                    mapsLoaded = true;
                    console.log('‚úÖ OpenRouteService API configured successfully');
                    console.log('API Key present:', orsApiKey.substring(0, 10) + '...');
                } else {
                    console.warn('‚ö† OpenRouteService API key not configured. Map visualization will be limited.');
                    console.warn('  Set OPENROUTESERVICE_API_KEY in .env file and restart server');
                    window.mapsLoaded = true; // Still allow map to load, but routes won't work
                    mapsLoaded = true;
                }
            } catch (error) {
                console.error('‚ùå Error loading maps config:', error);
                window.mapsLoaded = true; // Set even on error so script.js doesn't hang
                mapsLoaded = true;
            }
        }
        
        // Initialize maps config (runs immediately on page load)
        loadMapsConfig();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöï RealTaxi</h1>
            <p>Taxi Booking System</p>
        </header>

        <!-- Role Selection Screen -->
        <div id="role-selection" class="screen active">
            <div class="role-selection-container">
                <h2>Welcome to RealTaxi</h2>
                <p class="subtitle">Choose your role to continue</p>
                <div class="role-buttons">
                    <button class="role-btn passenger-btn" onclick="selectRole('passenger')">
                        <div class="role-icon">üë§</div>
                        <div class="role-title">Passenger</div>
                        <div class="role-desc">Book a ride</div>
                    </button>
                    <button class="role-btn driver-btn" onclick="selectRole('driver')">
                        <div class="role-icon">üöï</div>
                        <div class="role-title">Driver</div>
                        <div class="role-desc">Accept rides</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Passenger Flow -->
        <div id="passenger-flow" class="screen">
            <div class="flow-header">
                <button class="back-btn" onclick="goToRoleSelection()">‚Üê Back</button>
                <h2>Passenger Dashboard</h2>
            </div>

            <!-- Step 1: Register Passenger -->
            <div id="passenger-register" class="flow-step active">
                <div class="section">
                    <h2>üìù Register as Passenger</h2>
                    <p class="step-desc">Enter your details to get started</p>
                    <div class="form-group">
                        <input type="text" id="passenger-name" placeholder="Your Name" required>
                        <input type="text" id="passenger-phone" placeholder="Phone Number" required>
                        <input type="number" id="passenger-lat" placeholder="Latitude (e.g., 28.6139)" value="28.6139" step="0.0001" required>
                        <input type="number" id="passenger-lon" placeholder="Longitude (e.g., 77.2090)" value="77.2090" step="0.0001" required>
                        <select id="passenger-vehicle" required>
                            <option value="">Select Vehicle Preference</option>
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="hatchback">Hatchback</option>
                            <option value="premium">Premium</option>
                        </select>
                        <button onclick="registerPassenger()" class="primary-btn">Register & Continue</button>
                    </div>
                    <div id="passenger-register-status"></div>
                </div>
            </div>

            <!-- Step 2: Find Nearby Taxis -->
            <div id="passenger-find-taxis" class="flow-step">
                <div class="section">
                    <h2>üîç Find Nearby Taxis</h2>
                    <p class="step-desc">Enter your pickup location and destination to see available drivers with prices. Then select one to book.</p>
                    <div class="form-group">
                        <input type="text" id="search-user-id" placeholder="Your User ID" readonly>
                        <label style="font-weight: 600; margin-top: 10px; color: var(--taxi-black);">üìç Pickup Location</label>
                        <input type="number" id="search-lat" placeholder="Pickup Latitude" value="28.6139" step="0.0001">
                        <input type="number" id="search-lon" placeholder="Pickup Longitude" value="77.2090" step="0.0001">
                        <label style="font-weight: 600; margin-top: 10px; color: var(--taxi-black);">üèÅ Destination Location (Optional - for accurate fare calculation)</label>
                        <input type="number" id="search-dest-lat" placeholder="Destination Latitude (Optional)" value="28.7041" step="0.0001">
                        <input type="number" id="search-dest-lon" placeholder="Destination Longitude (Optional)" value="77.1025" step="0.0001">
                        <button onclick="findNearbyTaxis()" class="primary-btn">üîç Find Taxis</button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <p style="margin: 0; font-size: 0.9em; color: #1565c0;">
                            üí° <strong>Tip:</strong> Enter destination to see accurate fare prices based on ride distance. The map will show your route when you search for taxis.
                        </p>
                    </div>
                    <div id="nearby-taxis">
                        <div style="padding: 20px; text-align: center; color: #666;">
                            <p>üëÜ Enter pickup location and click "Find Taxis" to see available drivers with prices</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Book Taxi -->
            <div id="passenger-book" class="flow-step">
                <div class="section">
                    <h2>üöï Book a Taxi</h2>
                    <p class="step-desc">Review your selected driver and set your destination</p>
                    <div id="selected-driver-info" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--success-green); display: none;">
                        <p style="margin: 0; font-weight: 600; color: var(--taxi-black);">
                            ‚úì Selected Driver: <span id="selected-driver-display"></span>
                        </p>
                    </div>
                    <div class="form-group">
                        <input type="text" id="book-user-id" placeholder="Your User ID" readonly>
                        <input type="text" id="book-driver-id" placeholder="Driver ID (Select from nearby taxis)" required readonly style="background: #f5f5f5;">
                        <input type="number" id="book-pickup-lat" placeholder="Pickup Latitude" value="28.6139" step="0.0001">
                        <input type="number" id="book-pickup-lon" placeholder="Pickup Longitude" value="77.2090" step="0.0001">
                        <input type="number" id="book-dropoff-lat" placeholder="Dropoff Latitude" value="28.7041" step="0.0001">
                        <input type="number" id="book-dropoff-lon" placeholder="Dropoff Longitude" value="77.1025" step="0.0001">
                        <button onclick="bookTaxi()" class="primary-btn">üöï Book Taxi</button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid var(--taxi-yellow);">
                        <p style="margin: 0; font-size: 0.9em; color: #856404;">
                            üí° <strong>Tip:</strong> If driver ID is empty, go back to "Find Nearby Taxis" and select a driver first.
                        </p>
                    </div>
                    <div id="booking-status"></div>
                </div>
            </div>

            <!-- Step 4: Confirm Booking -->
            <div id="passenger-confirm" class="flow-step">
                <div class="section">
                    <h2>‚úÖ Confirm Booking</h2>
                    <p class="step-desc">Confirm your booking after driver accepts</p>
                    <div class="form-group">
                        <input type="text" id="confirm-user-id" placeholder="Your User ID" readonly>
                        <input type="text" id="confirm-booking-id" placeholder="Booking ID" readonly>
                        <button onclick="confirmBooking()" class="primary-btn">‚úì Confirm Booking</button>
                    </div>
                    <div id="confirm-status"></div>
                </div>
            </div>

            <!-- Step 5: Active Ride Status -->
            <div id="passenger-ride-status" class="flow-step">
                <div class="section">
                    <h2>üöó Your Ride Status</h2>
                    <div id="ride-status-content"></div>
                    <div class="form-group">
                        <button onclick="checkRideStatus()" class="primary-btn">üîÑ Refresh Status</button>
                        <button onclick="cancelBooking()" class="danger-btn">‚úï Cancel Ride</button>
                    </div>
                    <div id="ride-status-message"></div>
                </div>
            </div>
        </div>

        <!-- Driver Flow -->
        <div id="driver-flow" class="screen">
            <div class="flow-header">
                <button class="back-btn" onclick="goToRoleSelection()">‚Üê Back</button>
                <h2>Driver Dashboard</h2>
            </div>

            <!-- Step 1: Register Driver -->
            <div id="driver-register" class="flow-step active">
                <div class="section">
                    <h2>üìù Register as Driver</h2>
                    <p class="step-desc">Enter your driver details</p>
                    <div class="form-group">
                        <input type="text" id="driver-name" placeholder="Your Name" required>
                        <input type="text" id="driver-phone" placeholder="Phone Number" required>
                        <select id="driver-vehicle-type" required>
                            <option value="">Select Vehicle Type</option>
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="hatchback">Hatchback</option>
                            <option value="premium">Premium</option>
                        </select>
                        <input type="text" id="driver-vehicle-number" placeholder="Vehicle Number (e.g., DL-01-XX-1234)" required>
                        <button onclick="registerDriver()" class="primary-btn">Register & Continue</button>
                    </div>
                    <div id="driver-register-status"></div>
                </div>
            </div>

            <!-- Step 2: Go Online -->
            <div id="driver-online" class="flow-step">
                <div class="section">
                    <h2>üü¢ Go Online</h2>
                    <p class="step-desc">Go online to start receiving ride requests</p>
                    <div class="form-group">
                        <input type="text" id="online-driver-id" placeholder="Your Driver ID" readonly>
                        <input type="number" id="location-lat" placeholder="Your Latitude" value="28.6139" step="0.0001">
                        <input type="number" id="location-lon" placeholder="Your Longitude" value="77.2090" step="0.0001">
                        <button onclick="goOnline()" class="success-btn">üü¢ Go Online</button>
                        <button onclick="goOffline()" class="secondary-btn">‚ö´ Go Offline</button>
                    </div>
                    <div id="online-status"></div>
                </div>
            </div>

            <!-- Step 3: View Booking Requests -->
            <div id="driver-requests" class="flow-step">
                <div class="section">
                    <h2>üìã Booking Requests</h2>
                    <p class="step-desc">View and respond to ride requests</p>
                    <div class="form-group">
                        <input type="text" id="bookings-driver-id" placeholder="Your Driver ID" readonly>
                        <button onclick="getDriverBookings()" class="primary-btn">üîÑ Refresh Requests</button>
                    </div>
                    <div id="driver-bookings"></div>
                </div>
            </div>

            <!-- Step 4: Accept/Decline Booking -->
            <div id="driver-accept" class="flow-step">
                <div class="section">
                    <h2>‚úÖ Accept Booking</h2>
                    <p class="step-desc">Accept or decline ride requests</p>
                    <div class="form-group">
                        <input type="text" id="accept-driver-id" placeholder="Your Driver ID" readonly>
                        <input type="text" id="accept-booking-id" placeholder="Booking ID">
                        <button onclick="acceptBooking()" class="success-btn">‚úì Accept Booking</button>
                        <button onclick="declineBooking()" class="danger-btn">‚úï Decline</button>
                    </div>
                    <div id="accept-status"></div>
                </div>
            </div>

            <!-- Step 5: Active Ride Management -->
            <div id="driver-ride" class="flow-step">
                <div class="section">
                    <h2>üöó Active Ride</h2>
                    <div id="active-ride-content"></div>
                    <div class="form-group">
                        <input type="text" id="start-driver-id" placeholder="Your Driver ID" readonly>
                        <input type="text" id="start-booking-id" placeholder="Booking ID" readonly>
                        <button onclick="startRide()" class="primary-btn">‚ñ∂ Start Ride</button>
                        <button onclick="completeRide()" class="success-btn">üèÅ Complete Ride</button>
                    </div>
                    <div id="ride-action-status"></div>
                </div>
            </div>
        </div>

        <!-- Interactive Google Map Container -->
        <div id="map-container-wrapper" class="map-container" style="display: none;">
            <div id="google-map" style="width: 100%; height: 100%; border-radius: 16px;"></div>
            <div id="map-info" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; display: none;">
                <p style="margin: 0; font-size: 12px; color: #666;"><strong>Distance:</strong> <span id="map-distance">-</span></p>
                <p style="margin: 0; font-size: 12px; color: #666;"><strong>ETA:</strong> <span id="map-eta">-</span></p>
            </div>
        </div>
    </div>

    <script src="/static/script.js" defer></script>
</body>
</html>
